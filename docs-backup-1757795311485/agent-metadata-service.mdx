---
slug: trend-vision-one-agent-metadata-service
title: How does the agent use the Amazon Instance Metadata Service?
---
# How does the agent use the Amazon Instance Metadata Service?

When running on EC2 instances in AWS, the agent uses the Amazon Instance Metadata Service (IMDS) to query information about the EC2 instance.

:::note

Support for IMDS v2 was added in agent version 12 FR 2020-05-19. If you are using an older version of the agent, only IMDS v1 is supported and you must ensure that your AWS configuration allows the agent access to host metadata using IMDS v1.
:::

The information retrieved by the agent is necessary to ensure that the agent activates under the proper AWS account within Server & Workload Protection and the right instance size is used for metered billing.

If the agent cannot successfully retrieve data from the instance using a Metadata Service Version 1 (IMDSv1) or 2 (IMDSv2), the following issues might be encountered:

<table>
<thead>
<tr>
<th><p>Issue</p></th>
<th><p>Root cause</p></th>
<th><p>Resolution</p></th>
<th><p>Additional notes</p></th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Duplicate computers appear - one under the AWS account and another outside of the AWS account.</p></td>
<td><p>If the agent does not have access to Instance Metadata Service Version 1 (IMDSv1) or 2 (IMDSv2), Server &amp; Workload Protection cannot properly associate this activation with the desired cloud account.</p></td>
<td><p>Ensure that Server &amp; Workload Protection has access to IMDS v1 or IMDS v2.</p>
<p>For details, see <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service">Configuring the Instance Metadata Service</a>.</p></td>
<td><p>If you determine that the creation of duplicate computers has occurred, you can use <a href="trend-vision-one-automate-inactive-agent-cleanup">inactive agent cleanup</a> to automatically remove these computers.</p></td>
</tr>
<tr>
<td><p>Incorrect billing of instance hours .</p></td>
<td><p>If the agent does not have access to Instance Metadata Service Version 1 (IMDSv1) or 2 (IMDSv2), Server &amp; Workload Protection cannot properly determine the instance size for metered billing. As a result, the computer does not appear under a cloud account and is charged at the data center rate.</p></td>
<td><p>If you believe overbilling has occurred please ensure that:</p>
<ol>
<li>The agent has access to IMDS v1 or IMDS v2.</li>
<li>You have added the AWS cloud account to Server &amp; Workload Protection.</li>
</ol></td>
<td><p>Adding AWS accounts is now handled by the Cloud Accounts app. Credit usage is based on enabled Trend Vision One Cloud Security features. For more information about credits, see <a href="trend-vision-one-credit-usage">Credit Usage</a>.</p></td>
</tr>
<tr>
<td><p>Smart folders or event-based tasks based on AWS metadata fail.</p></td>
<td><p>If the agent does not have access to Instance Metadata Service Version 1 (IMDSv1) or 2 (IMDSv2), Server &amp; Workload Protection cannot access the AWS metadata needed for these operations.</p></td>
<td><p>N/A</p></td>
<td></td>
</tr>
</tbody>
</table>
::::
